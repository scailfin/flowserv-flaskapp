swagger: "2.0"
info:
  description: "API specification for the Flask Web server of the Reproducible and Reusable Data Analysis Workflow platform."
  version: "0.1.0"
  title: "Reproducible and Reusable Data Analysis Workflow Server - Flask App Template - API"
  contact:
    email: "heiko.muller@gmail.com"
  license:
    name: "MIT"
    url: "https://opensource.org/licenses/MIT"
# -----------------------------------------------------------------------------
# Base URL
# -----------------------------------------------------------------------------
schemes:
- "http"
host: "localhost:5000"
basePath: "/flaskflow/api/v1"
# -----------------------------------------------------------------------------
# Grouping of API Routes
# -----------------------------------------------------------------------------
tags:
- name: "service"
  description: "Service description"
- name: "workflow"
  description: "Workflow templates"
- name: "run"
  description: "Workflow runs"
- name: "file"
  description: "Uploaded files for workflow runs"
- name: "user"
  description: "Authenticate and register users"
# -----------------------------------------------------------------------------
# API Routes
# -----------------------------------------------------------------------------
paths:
# -- Service ------------------------------------------------------------------
  /:
    get:
      tags:
      - "service"
      summary: "Service descriptor"
      description: "Get service descriptor"
      operationId: "serviceDescriptor"
      produces:
      - "application/json"
      responses:
        200:
          description: "Service descriptor"
          schema:
            $ref: "#/definitions/ServiceDescriptor"
      security:
        - api_key: []
# -- Workflows ----------------------------------------------------------------
  /workflows/{workflowId}:
    get:
      tags:
      - "workflow"
      summary: "Get workflow handle"
      description: "Get handle for the given workflow"
      operationId: "getWorkflow"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      responses:
        200:
          description: "Success"
          schema:
            $ref: "#/definitions/WorkflowHandle"
        404:
          description: "Unknown workflow"
# -- Runs ---------------------------------------------------------------------
  /workflows/{workflowId}/runs:
    get:
      tags:
      - "run"
      summary: "List workflow runs"
      description: "Get listing of all runs for the given workflow"
      operationId: "listRuns"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      responses:
        200:
          description: "Run listing"
          schema:
            $ref: "#/definitions/RunListing"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown workflow"
      security:
        - api_key: []
    post:
      tags:
      - "run"
      summary: "Run workflow"
      description: "Submit arguments for a new workflow run"
      operationId: "runWorkflow"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      - name: body
        in: body
        required: true
        description: Run arguments
        schema:
          type: object
          required:
          - arguments
          properties:
            arguments:
              type: array
              items:
                $ref: '#/definitions/RunArgument'
      responses:
        201:
          description: "Run state"
          schema:
            $ref: "#/definitions/RunHandle"
        400:
          description: "Invalid argument list"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown workflow"
      security:
        - api_key: []
  /workflows/{workflowId}/runs/poll:
    get:
      tags:
      - "run"
      summary: "Poll runs state"
      description: "Get listing of all runs in a given state"
      operationId: "pollRuns"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "workflowId"
        description: "Unique workflow identifier"
        required: true
        type: string
      - in: "query"
        name: "state"
        description: "Run state identifier"
        required: false
        type: string
      responses:
        200:
          description: "Run identifier listing"
          schema:
            $ref: "#/definitions/RunIdentifierListing"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown workflow"
      security:
        - api_key: []
  /runs/{runId}:
    delete:
      tags:
      - "run"
      summary: "Delete run"
      description: "Delete an inactive run"
      operationId: "deleteRun"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      responses:
        204:
          description: "Run deleted"
        400:
          description: "Invalid request for run state"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
      security:
        - api_key: []
    get:
      tags:
      - "run"
      summary: "Get run"
      description: "Get state and timestamps for a given run"
      operationId: "getRun"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      responses:
        200:
          description: "Run handle"
          schema:
            $ref: "#/definitions/RunHandle"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
      security:
        - api_key: []
    put:
      tags:
      - "run"
      summary: "Cancel run"
      description: "Cancel execution of an active run"
      operationId: "cancelRun"
      produces:
      - "application/json"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      - name: body
        in: body
        required: true
        description: Run arguments
        schema:
          type: object
          properties:
            reason:
              type: string
      responses:
        200:
          description: "Run handle"
          schema:
            $ref: "#/definitions/RunHandle"
        400:
          description: "Invalid request for run state"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
      security:
        - api_key: []
# -- Files --------------------------------------------------------------------
  /runs/{runId}/files/uploads/{fileId}:
    get:
      tags:
      - "file"
      summary: "Download file"
      description: "Download input file for workflow run"
      operationId: "downloadFile"
      produces:
      - "text/csv"
      - "application/gzip"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      - in: "path"
        name: "fileId"
        description: "Unique file identifier"
        required: true
        type: string
      responses:
        200:
          description: "File"
        404:
          description: "Unknown run or file"
  /runs/{runId}/files/downloads/archive:
    get:
      tags:
      - "file"
      summary: "Download result file archive"
      description: "Download a tar archive containing all result files generated by a workflow run"
      operationId: "downloadRunResultArchive"
      produces:
      - "application/gzip"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      responses:
        200:
          description: "File"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run"
  /runs/{runId}/files/downloads/resources/{resourceId}:
    get:
      tags:
      - "file"
      summary: "Download result file"
      description: "Download a result file from a successful workflow run"
      operationId: "downloadResultFile"
      produces:
      - "text/csv"
      - "application/gzip"
      parameters:
      - in: "path"
        name: "runId"
        description: "Unique run identifier"
        required: true
        type: string
      - in: "path"
        name: "resourceId"
        description: "Unique resource identifier"
        required: true
        type: string
      responses:
        200:
          description: "File"
        403:
          description: "Forbidden operation"
        404:
          description: "Unknown run or resource"
# -- Users --------------------------------------------------------------------
  /users:
    get:
      tags:
      - "user"
      summary: "List users"
      description: "Query listing of registered users"
      operationId: "listUsers"
      produces:
      - "application/json"
      parameters:
      - in: "query"
        name: "query"
        description: "User name"
        required: false
        type: string
      responses:
        200:
          description: "Query result"
          schema:
            $ref: "#/definitions/UserListing"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
  /users/activate:
    post:
      tags:
      - "user"
      summary: "Activate a new user"
      description: "Activate a newly registered user"
      operationId: "activateUser"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "Identifier for a registered user"
        required: true
        schema:
          type: object
          description: "Unique user identifier"
          required:
          - id
          properties:
            id:
              type: string
      responses:
        200:
          description: "User activated successfully"
          schema:
            $ref: "#/definitions/UserHandle"
        404:
          description: "Unknown user"
  /users/login:
    post:
      tags:
      - "user"
      summary: "User login"
      description: "Logs user into the system"
      operationId: "loginUser"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "User name and password"
        required: true
        schema:
          $ref: "#/definitions/UserCredentials"
      responses:
        200:
          description: "User logged in successfully"
          schema:
            $ref: "#/definitions/UserHandle"
        400:
          description: "Invalid username/password supplied"
        404:
          description: "Unknown user"
  /users/logout:
    post:
      tags:
      - "user"
      summary: "Logout user"
      description: "Logs current user out"
      operationId: "logoutUser"
      produces:
      - "application/json"
      responses:
        200:
          description: "User logged out successfully"
          schema:
            $ref: "#/definitions/UserHandle"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
  /users/password/request:
    post:
      tags:
      - "user"
      summary: "Request password reset"
      description: "Get unique request identifier to reset user password"
      operationId: "requestPasswordReset"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "User name"
        required: true
        schema:
          type: object
          required:
          - username
          properties:
            username:
              type: string
      responses:
        200:
          description: "User activated successfully"
          schema:
            type: object
            required:
            - requestId
            properties:
              requestId:
                type: string
  /users/password/reset:
    post:
      tags:
      - "user"
      summary: "Reset password"
      description: "Reset the password for a user following a password reset request"
      operationId: "resetPassword"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "Reset request identifier and new password"
        required: true
        schema:
          type: object
          required:
          - requestId
          - password
          properties:
            requestId:
              type: string
            password:
              type: string
      responses:
        200:
          description: "User activated successfully"
          schema:
            $ref: "#/definitions/UserHandle"
  /users/register:
    post:
      tags:
      - "user"
      summary: "Register user"
      description: "Create a new user"
      operationId: "registerUser"
      produces:
      - "application/json"
      parameters:
      - in: "body"
        name: "body"
        description: "User name and password"
        required: true
        schema:
          $ref: "#/definitions/UserRegistration"
      responses:
        201:
          description: "successful operation"
          schema:
            $ref: "#/definitions/UserHandle"
        400:
          description: "Invalid or existing username supplied"
  /users/whoami:
    get:
      tags:
      - "user"
      summary: "Get user information"
      description: "Get information about user that is associated with the provided access token"
      operationId: "whoami"
      produces:
      - "application/json"
      responses:
        200:
          description: "User Handle"
          schema:
            $ref: "#/definitions/UserHandle"
        403:
          description: "Forbidden operation"
      security:
        - api_key: []
# ------------------------------------------------------------------------------
# Security
# ------------------------------------------------------------------------------
securityDefinitions:
  api_key:
    type: apiKey
    name: api_key
    in: header
# ------------------------------------------------------------------------------
# Definition of data structures (models)
# ------------------------------------------------------------------------------
definitions:
  FileHandle:
    type: object
    description: "Handle for uploaded file"
    required:
    - id
    - name
    - createdAt
    - size
    properties:
      id:
        type: string
      name:
        type: string
      createdAt:
        type: string
      size:
        type: number
  RunArgument:
    type: object
    description: "Argument for a new benchmark run"
    required:
    - id
    - value
    properties:
      id:
        type: string
      value:
        type: string
      as:
        type: string
  RunDescriptor:
    type: object
    description: "Descriptor containing basic information for benchmark run"
    required:
    - id
    - state
    - createdAt
    properties:
      id:
        type: string
      state:
        type: string
      createdAt:
        type: string
  RunHandle:
    type: object
    description: "Handle containing all information for a benchmark run"
    required:
    - id
    - benchmark
    - parameters
    - arguments
    - state
    properties:
      id:
        type: string
      benchmark:
        type: string
      submission:
        type: string
      parameters:
        type: array
        items:
          $ref: '#/definitions/WorkflowParameter'
      arguments:
        type: array
        items:
          $ref: "#/definitions/RunArgument"
      state:
        type: string
      startedAt:
        type: string
      finishedAt:
        type: string
      messages:
        type: array
        items:
          type: string
      files:
        type: array
        items:
          type: object
          required:
          - id
          - name
          properties:
            id:
              type: string
            name:
              type: string
            title:
              type: string
            caption:
              type: string
            widget:
              type: string
            format:
              type: object
  RunIdentifierListing:
    type: object
    description: "List of run identifier"
    required:
    - runs
    properties:
      runs:
        type: array
        items:
          type: string
  RunListing:
    type: object
    description: "Listing of run handles"
    required:
    - runs
    properties:
      runs:
        type: array
        items:
          $ref: "#/definitions/RunDescriptor"
  ServiceDescriptor:
    type: object
    description: "Descriptor containing basic service properties"
    required:
    - name
    - version
    - validToken
    - routes
    properties:
      name:
        type: string
      version:
        type: string
      validToken:
        type: boolean
      username:
        type: string
      routes:
        type: array
        items:
          type: object
          required:
          - action
          - pattern
          properties:
            action:
              type: string
            pattern:
              type: string
  SubmissionListing:
    type: object
    description: List of submission descriptors
    required:
    - submissions
    properties:
      submissions:
        type: array
        items:
          type: object
          required:
          - id
          - name
          - benchmark
          properties:
            id:
              type: string
            name:
              type: string
            benchmark:
              type: string
  UserCredentials:
    type: object
    description: "User login credentials"
    required:
    - username
    - password
    properties:
      username:
        type: string
      password:
        type: string
  UserHandle:
    type: object
    description: "Information about a registered user"
    required:
    - id
    - username
    properties:
      id:
        type: string
      username:
        type: string
      token:
        type: string
  UserListing:
    type: object
    description: "Identifier and name of a registered users"
    required:
    - users
    properties:
      users:
        type: array
        items:
          type: object
          required:
          - id
          - username
          properties:
            id:
              type: string
            username:
              type: string
  UserRegistration:
    type: object
    description: "Information about a new user"
    required:
    - username
    - password
    properties:
      username:
        type: string
      password:
        type: string
      verify:
        type: boolean
  WorkflowHandle:
    type: object
    required:
    - id
    - name
    - parameters
    - submissions
    properties:
      id:
        type: string
      name:
        type: string
      description:
        type: string
      instructions:
        type: string
      parameters:
        type: array
        items:
          $ref: '#/definitions/WorkflowParameter'
      modules:
        type: array
        items:
          type: object
          required:
          - id
          - name
          - index
          properties:
            id:
              type: string
            name:
              type: string
            index:
              type: number
              format: int64
      postproc:
        $ref: "#/definitions/RunHandle"
      outputs:
        type: array
        items:
          type: object
          properties:
            id:
              type: string
            title:
              type: string
            caption:
              type: string
      submissions:
        $ref: "#/definitions/SubmissionListing"
  WorkflowParameter:
    type: object
    required:
    - id
    - name
    - datatype
    - index
    - required
    properties:
      id:
        type: string
      name:
        type: string
      datatype:
        type: string
      index:
        type: integer
      required:
        type: boolean
      description:
        type: string
      as:
        type: string
      defaultValue:
        type: string
      parent:
        type: string
      values:
        type: array
        items:
          type: object
          required:
          - value
          properties:
            name:
              type: string
            value:
              type: string
            isDefault:
              type: boolean
externalDocs:
  description: "Find out more about Swagger"
  url: "http://swagger.io"
